<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head th:replace="fragments/head"/>
<body>
<div th:replace="fragments/navbar"></div>
<main class="container">
    <hgroup>
        <h1>Все сотрудники</h1>
    </hgroup>

    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
        <div style="display: flex; flex-wrap: wrap; gap: 5px; align-items: center;">
            <span style="font-weight: bold; margin-right: 5px;">Отдел:</span>
            <a href="/employees/all" 
               th:class="${selectedDepartment == null} ? 'department-btn active' : 'department-btn'"
               style="padding: 5px 10px; border: 1px solid #ccc; border-radius: 4px; text-decoration: none; font-size: 0.9rem;">
                Все
            </a>
            
            <a th:each="dept : ${departments}"
               th:href="@{/employees/all?department={id}(id=${dept.id})}"
               th:class="${selectedDepartment != null and selectedDepartment == dept.id} ? 'department-btn active' : 'department-btn'"
               th:text="${dept.shortName}"
               style="padding: 5px 10px; border: 1px solid #ccc; border-radius: 4px; text-decoration: none; font-size: 0.9rem;">
            </a>
        </div>
    </div>
        <form method="get" action="/employees/all" id="searchForm" style="flex-grow: 1">
            <div style="display: flex; gap: 5px;">
                <input type="search"
                       name="search"
                       th:value="${search}"
                       placeholder="Поиск сотрудников..."
                       aria-label="Поиск"
                       id="searchInput"
                       autocomplete="off"
                       style="flex-grow: 1;">
                <input type="hidden" 
                       name="department" 
                       th:value="${selectedDepartment}">
            </div>
        </form>

    <div id="resultsContainer">
        <div style="
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-top: 20px;
        ">
            <div th:each="e : ${allEmployees}" class="card" style="margin-bottom: 0;">
                <h3><strong th:text="${e.lastName} + ' ' + ${e.firstName} + ' ' + ${e.middleName}"></strong></h3>
                <h4><strong th:text="${e.departmentShortName}"></strong></h4>
                <p th:if="${e.workPhone}">
                    Рабочий телефон: 
                    <a th:href="'tel:' + ${#strings.replace(e.workPhone, ' ', '')}" 
                    th:text="${e.workPhone}"
                    style="font-weight: bold; text-decoration: none;"></a>
                </p>
                <p th:if="${e.personalPhone}">
                    Личный телефон: 
                    <a th:href="'tel:' + ${#strings.replace(e.personalPhone, ' ', '')}" 
                    th:text="${e.personalPhone}"
                    style="font-weight: bold; text-decoration: none;"></a>
                </p>
                <p th:if="${e.email}">
                    Email:
                    <a th:href="'mailto:' + ${e.email}" 
                    th:text="${e.email}"
                    style="font-weight: bold; text-decoration: none;"></a>
                </p>
                <p>
                    Кабинет:
                    <span th:text="${e.officeNumber}" style="font-weight: bold;"></span>
                </p>
                <p th:if="${e.additionalInfo}">
                    Telegram:
                    <a th:href="'https://t.me/' + ${e.additionalInfo}" 
                    th:text="'@' + ${e.additionalInfo}"
                    style="font-weight: bold; text-decoration: none;"></a>
                </p>
                <p th:if="${e.statusNote}">
                    Дополнительная информация:
                    <span th:text="${e.statusNote}" style="font-weight: bold;"></span>
                </p>
                
                <div sec:authorize="hasAnyRole('ADMIN', 'MODERATOR')">
                    <form th:action="@{/employees/update/{name}(name=${e.lastName + ' ' + e.firstName + ' ' + e.middleName})}"
                        th:method="get">
                        <button type="submit" class="primary">Изменить</button>
                    </form>
                </div>
                <div sec:authorize="hasAnyRole('ADMIN', 'MODERATOR')">
                    <form th:action="@{/employees/employee-delete/{name}(name=${e.lastName + ' ' + e.firstName + ' ' + e.middleName})}"
                          th:method="delete"
                          onsubmit="return confirm('Вы уверены, что хотите удалить этого сотрудника?')">
                        <button type="submit" class="secondary">Удалить сотрудника</button>
                    </form>
                </div>
            </div>
        </div>
        
        <p th:if="${#lists.isEmpty(allEmployees)}" class="text-center">
            <em>Сотрудники не найдены. 
                <span th:if="${selectedDepartment != null}">
                    В выбранном отделе нет сотрудников.
                </span>
                <span th:unless="${selectedDepartment != null}">
                    Добавьте новых сотрудников, чтобы начать!
                </span>
            </em>
        </p>
    </div>
</main>

<footer th:replace="fragments/footer"></footer>

<style>
    .department-btn.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
        font-weight: bold;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const resultsContainer = document.getElementById('resultsContainer');
        const searchForm = document.getElementById('searchForm');
        const departmentInput = searchForm.querySelector('input[name="department"]');
        let debounceTimer;

        searchInput.addEventListener('input', function() {
            const cursorPosition = this.selectionStart;
            const searchValue = this.value;
            
            clearTimeout(debounceTimer);
            
            debounceTimer = setTimeout(() => {
                const url = new URL(window.location.href.split('?')[0]);
                url.searchParams.set('search', searchValue);
                
                // Добавляем параметр отдела, если он есть
                const currentDepartment = new URL(window.location.href).searchParams.get('department');
                if (currentDepartment) {
                    url.searchParams.set('department', currentDepartment);
                }
                
                fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    const newResultsContainer = doc.getElementById('resultsContainer');
                    
                    if (newResultsContainer) {
                        resultsContainer.innerHTML = newResultsContainer.innerHTML;
                    }
                    
                    searchInput.focus();
                    searchInput.setSelectionRange(cursorPosition, cursorPosition);
                })
                .catch(error => {
                    console.error('Ошибка при поиске:', error);
                });
            }, 300);
        });

        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                clearTimeout(debounceTimer);
                
                const event = new Event('input', {
                    bubbles: true,
                    cancelable: true,
                });
                this.dispatchEvent(event);
            }
        });
        
        searchInput.focus();
    });
</script>
</body>
</html>