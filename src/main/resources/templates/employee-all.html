<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.w3.org/1999/xhtml">
<head th:replace="fragments/head"/>
<body>
<div th:replace="fragments/navbar"></div>
<main class="container">
    <hgroup>
        <h1>Все сотрудники</h1>
        <p>Просмотрите всех сотрудников ИУЦТ</p>
    </hgroup>

    <div sec:authorize="hasRole('ADMIN')">
        <button onclick="window.location.href='/employees/add'" class="button">Добавить сотрудника</button>
    </div>

    <form method="get" action="/employees/all" id="searchForm">
        <div class="grid">
            <input type="search"
                   name="search"
                   th:value="${search}"
                   placeholder="Поиск сотрудников..."
                   aria-label="Поиск"
                   id="searchInput"
                   autocomplete="off">
        </div>
    </form>

    <div id="resultsContainer">
        <div style="
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
            margin-top: 20px;
        ">
            <div th:each="e : ${allEmployees}" class="card" style="margin-bottom: 0;">
                <h7>
                    <span th:text="${e.lastName} + ' ' + ${e.firstName} + ' ' + ${e.middleName}"></span>
                    <span sec:authorize="hasRole('ADMIN')" style="margin-left: 10px;">
                        <a th:href="@{'/employees/update/' + ${e.lastName} + ' ' + ${e.firstName} + ' ' + ${e.middleName}}">
                            Изменить
                        </a>
                    </span>
                </h7>
                <h5 th:text="${e.departmentShortName}"></h5>
                <p th:if="${e.workPhone}"><strong>Рабочий телефон:</strong> <a th:href="'tel:' + ${#strings.replace(e.workPhone, ' ', '')}" th:text="${e.workPhone}"></a></p>
                <p th:if="${e.personalPhone}"><strong>Личный телефон:</strong> <a th:href="'tel:' + ${#strings.replace(e.personalPhone, ' ', '')}" th:text="${e.personalPhone}"></a></p>
                <p th:if="${e.email}"><strong>Email:</strong> <a th:href="'mailto:' + ${e.email}" th:text="${e.email}"></a></p>
                <p><strong>Кабинет:</strong> <span th:text="${e.officeNumber}"></span></p>
                <p th:if="${e.additionalInfo}"><strong>Telegram:</strong> <a th:href="'https://t.me/' + ${e.additionalInfo}" th:text="'@' + ${e.additionalInfo}"></a></p>
                <p th:if="${e.statusNote}"><strong>Дополнительная информация:</strong> <span th:text="${e.statusNote}"></span></p>
                
                <div sec:authorize="hasAnyRole('ADMIN', 'MODERATOR')">
                    <form th:action="@{/employees/employee-delete/{name}(name=${e.lastName + ' ' + e.firstName + ' ' + e.middleName})}"
                          th:method="delete"
                          onsubmit="return confirm('Вы уверены, что хотите удалить этого сотрудника?')">
                        <button type="submit" class="secondary">Удалить сотрудника</button>
                    </form>
                </div>
            </div>
        </div>
        
        <p th:if="${#lists.isEmpty(allEmployees)}" class="text-center">
            <em>Сотрудники не найдены. Добавьте новых сотрудников, чтобы начать!</em>
        </p>
    </div>
</main>

<footer th:replace="fragments/footer"></footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const resultsContainer = document.getElementById('resultsContainer');
        let debounceTimer;

        searchInput.addEventListener('input', function() {
            const cursorPosition = this.selectionStart;
            const searchValue = this.value;
            
            clearTimeout(debounceTimer);
            
            debounceTimer = setTimeout(() => {
                const url = new URL(window.location.href.split('?')[0]);
                url.searchParams.set('search', searchValue);
                
                fetch(url, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.text();
                })
                .then(html => {
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    
                    const newResultsContainer = doc.getElementById('resultsContainer');
                    
                    if (newResultsContainer) {
                        resultsContainer.innerHTML = newResultsContainer.innerHTML;
                    }
                    
                    searchInput.focus();
                    searchInput.setSelectionRange(cursorPosition, cursorPosition);
                })
                .catch(error => {
                    console.error('Ошибка при поиске:', error);
                });
            }, 300);
        });

        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                clearTimeout(debounceTimer);
                
                const event = new Event('input', {
                    bubbles: true,
                    cancelable: true,
                });
                this.dispatchEvent(event);
            }
        });
        searchInput.focus();
    });
</script>
</body>
</html>